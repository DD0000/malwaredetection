from django.shortcuts import render, redirect
from django.conf import settings
from django.core.files.storage import FileSystemStorage

from uploads.core.models import Document
from uploads.core.forms import DocumentForm
import hashlib, os
import json
import requests
from django.http import JsonResponse
import pysftp
import subprocess
import paramiko

#from __future__ import print_function
from virus_total_apis import PublicApi as VirusTotalPublicApi


def home(request):
    documents = Document.objects.all()
    return render(request, 'core/home.html', { 'documents': documents })


def simple_upload(request):
    if request.method == 'POST' and request.FILES['myfile']:
        myfile = request.FILES['myfile']
        fs = FileSystemStorage()
        filename = fs.save(myfile.name, myfile)
        uploaded_file_url = fs.url(filename)

        filenames = 'C:/Desktop/project_name' + uploaded_file_url

###

        dosya = "/root/Desktop/project/aa.txt"
        cnopts = pysftp.CnOpts()
        cnopts.hostkeys = None
        with pysftp.Connection(host='ip_address', username='username', password='password', cnopts=cnopts) as sftp:
            sftp.put(filenames, '/root/Desktop/proje/aa.txt')
            filecommand = sftp.execute('file ' + dosya)
            exiftool = sftp.execute('exiftool ' + dosya)
            binwalk = sftp.execute('binwalk ' + dosya)



        sha1_hash = hashlib.sha1()
        with open(filenames, "rb") as f:
            # Read and update hash in chunks of 4K
            for byte_block in iter(lambda: f.read(4096), b""):
                sha1_hash.update(byte_block)
            file = sha1_hash.hexdigest()

        url = 'https://www.virustotal.com/vtapi/v2/file/report'

        params = {'apikey': 'api_key', 'resource': file}

        response = requests.get(url, params=params)

        ###

        sonuc = response.json()

        aa = json.dumps(sonuc, indent=4)


        return render(request, 'core/simple_upload.html', {
            'uploaded_file_url': uploaded_file_url, 'file': file, 'filecommand': filecommand , 'exiftool': exiftool , 'binwalk': binwalk ,'aa': aa
        })

    return render(request, 'core/simple_upload.html')


def model_form_upload(request):
    if request.method == 'POST':
        form = DocumentForm(request.POST, request.FILES)
        if form.is_valid():
            form.save()
            return redirect('home')
    else:
        form = DocumentForm()
    return render(request, 'core/model_form_upload.html', {
        'form': form
    })
